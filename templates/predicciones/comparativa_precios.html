{% extends 'base.html' %}
{% load static %}
{% load predicciones_filters %}

{% block title %}Comparativa de Precios{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/predicciones.css' %}">
{% endblock %}

{% block content %}
<div class="wrapper">
    <div class="details-header">
        <h2>Comparativa de Precios para Productos Alcohólicos</h2>
        <p class="subtitle">Análisis de precios a lo largo del año para identificar oportunidades de compra</p>
    </div>
    
    {% for producto in productos %}
    <div class="prediccion-section">
        <div class="prediccion-header">
            <h3>{{ producto.nombre }}</h3>
            <p class="prediccion-subtitle">Comparativa de precios a lo largo del año</p>
        </div>
        <div class="prediccion-content">
            <div class="chart-container">
                <canvas id="chart-{{ producto.id }}"></canvas>
            </div>
            
            <div class="row" style="display: flex; margin-top: 1.5rem;">
                <div style="flex: 1; margin-right: 1rem;">
                    <div class="prediccion-container">
                        <div class="prediccion-header">
                            <h3>Meses de Oportunidad</h3>
                            <p class="prediccion-subtitle">Meses con precios más bajos que el promedio anual</p>
                        </div>
                        <div class="prediccion-content">
                            <ul style="list-style: none; padding: 0;">
                                {% for mes_num in producto.meses_oportunidad %}
                                    <li style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border-color);">
                                        {{ meses|index:mes_num|default:"Desconocido" }}
                                        <span class="badge bg-success">Oportunidad</span>
                                    </li>
                                {% empty %}
                                    <li style="padding: 0.5rem;">No se identificaron meses de oportunidad</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                <div style="flex: 1;">
                    <div class="prediccion-container">
                        <div class="prediccion-header">
                            <h3>Meses de Precaución</h3>
                            <p class="prediccion-subtitle">Meses con precios más altos que el promedio anual</p>
                        </div>
                        <div class="prediccion-content">
                            <ul style="list-style: none; padding: 0;">
                                {% for mes_num in producto.meses_precaucion %}
                                    <li style="display: flex; justify-content: space-between; padding: 0.5rem; border-bottom: 1px solid var(--border-color);">
                                        {{ meses|index:mes_num|default:"Desconocido" }}
                                        <span class="badge bg-danger">Precaución</span>
                                    </li>
                                {% empty %}
                                    <li style="padding: 0.5rem;">No se identificaron meses de precaución</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="alert alert-info">
        <p>No hay datos disponibles para mostrar.</p>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script id="datos-productos" type="application/json">
    {% if productos %}
    [
        {% for producto in productos %}
        {
            "id": {{ producto.id }},
            "nombre": "{{ producto.nombre }}",
            "precio_actual": {{ producto.precio_actual }},
            "precios_mensuales": {{ producto.precios_mensuales|safe }},
            "variaciones_mensuales": {{ producto.variaciones_mensuales|safe }},
            "meses_oportunidad": {{ producto.meses_oportunidad|safe }},
            "meses_precaucion": {{ producto.meses_precaucion|safe }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
    {% else %}[]
    {% endif %}
</script>
<script id="datos-meses" type="application/json">
    {% if meses %}
    [{% for mes in meses %}"{{ mes }}"{% if not forloop.last %}, {% endif %}{% endfor %}]
    {% else %}[]
    {% endif %}
</script>
<script src="{% static 'js/predicciones_comparativa.js' %}"></script>
{% endblock %}
